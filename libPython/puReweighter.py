import ROOT as rt
import numpy as np
import sys
import argparse
import os

print '** puReweighter requires root_numpy.'
print '** To install on lxplus: '
print 'pip install --user root_numpy'
from root_numpy import  tree2array, array2tree


customWeights_17Nov2017MCv2 = {

    '2017_runB' : [ 2.78721e-09,
                    8.29537e-06,    0.0161464,      0.026547,       0.0470691,      0.0902818,      0.115647,       0.197857,
                    0.150448,       0.407495,       0.631471,       0.885343,       0.973195,       0.99756,        0.985337,
                    0.971295,       1.03354,        1.11933,        1.27721,        1.42536,        1.5472,         1.64752,
                    1.73905,        1.80084,        1.82923,        1.87493,        1.89668,        1.95769,        2.00439,
                    1.99327,        1.92761,        1.81131,        1.66118,        1.49815,        1.30579,        1.13063,
                    0.961473,       0.787239,       0.624429,       0.48327,        0.369995,       0.286518,       0.21152,
                    0.1527,         0.107546,       0.0723541,      0.0462112,      0.0272659,      0.0158567,      0.00874781,
                    0.00465276,     0.00245155,     0.00127945,     0.000665264,    0.000345037,    0.000174231,    9.2684e-05,
                    4.96701e-05,    2.68951e-05,    1.48571e-05,    8.49208e-06,    4.95017e-06,    2.93006e-06,    1.72019e-06,
                    1.05594e-06,    5.6375e-07,     3.00895e-07,    1.7454e-07,     1.06697e-07,    6.51644e-08,    3.67269e-08,
                    2.04583e-08,    8.83731e-09,    5.02539e-09,    1.47299e-09,    1.19777e-09,    3.39483e-10,    1.38009e-10,
                    3.51009e-11,    1.17901e-11,    1.48352e-12,    1.24697e-12,    4.94523e-13,    7.33467e-14,    2.21055e-14,
                    5.89623e-15,    4.46766e-15,    2.92693e-16,    1.06557e-16,    0,              0,              0,
                    0,              0,              0,              0,              0,              0,              0,
                    0,     ],
    '2017_runC' : [
         0.00026112,     0.0221736,      0.0128291,      0.0402351,      0.0831826,      0.0843967,      0.103655,
         0.162653,       0.110466,       0.219185,       0.260169,       0.437633,       0.713618,       1.07405,
         1.40912,        1.63428,        1.79933,        1.81333,        1.82617,        1.79701,        1.76691,
         1.75503,        1.76225,        1.75565,        1.72997,        1.73201,        1.72014,        1.75096,
         1.77686,        1.76028,        1.70267,        1.6046,         1.47877,        1.34319,        1.18282,
         1.03883,        0.899946,       0.753974,       0.614721,       0.491496,       0.391122,       0.317238,
         0.24766,        0.191283,       0.146115,       0.108253,       0.077375,       0.0519158,      0.0348403,
         0.0224469,      0.0140553,      0.00874558,     0.00537733,     0.00326879,     0.00195802,     0.00112472,
         0.000669624,    0.000395475,    0.000232925,    0.000138601,    8.48229e-05,    5.2811e-05,     3.34134e-05,
         2.10412e-05,    1.39333e-05,    8.08446e-06,    4.73116e-06,    3.03913e-06,    2.07966e-06,    1.43816e-06,
         9.28805e-07,    6.0019e-07,     3.04539e-07,    2.05993e-07,    7.27239e-08,    7.21124e-08,    2.52269e-08,
         1.28077e-08,    4.11458e-09,    1.76487e-09,    2.86572e-10,    3.13933e-10,    1.63882e-10,    3.2294e-11,
         1.30346e-11,    4.69725e-12,    4.78323e-12,    4.27695e-13,    2.12691e-13,    7.98385e-14,    1.24132e-13,
         2.83648e-14,    1.90417e-14,    9.3247e-15,     4.84836e-16,    1.78391e-16,    1.01492e-16,    0,
         0,              0,        ],


    '2017_runD' : [
        5.34841e-13,    1.06439e-05,    0.00754941,     0.0370866,      0.11429,        0.161627,       0.160145,
        0.193843,       0.0959119,      0.131594,       0.100569,       0.0861817,      0.0870812,      0.112852,
        0.202798,       0.456788,       0.952825,       1.41875,        1.71069,        1.85345,        1.93503,
        1.95719,        1.98401,        2.06412,        2.17753,        2.30768,        2.35005,        2.37909,
        2.34232,        2.19786,        1.96846,        1.68956,        1.40551,        1.14775,        0.907517,
        0.716872,       0.561438,       0.428375,       0.320232,       0.235508,       0.172047,       0.127177,
        0.0894371,      0.0613196,      0.0408963,      0.0259897,      0.0156401,      0.00866272,     0.00469865,
        0.00239154,     0.00115432,     0.000539369,    0.000242296,    0.000104587,    4.32024e-05,    1.66102e-05,
        6.42136e-06,    2.38797e-06,    8.58457e-07,    3.0211e-07,     1.05913e-07,    3.65733e-08,    1.24209e-08,
        4.06169e-09,    1.35058e-09,    3.80359e-10,    1.04387e-10,    3.03702e-11,    9.08708e-12,    2.65174e-12,
        6.97249e-13,    1.76923e-13,    3.39878e-14,    8.42428e-15,    1.00883e-15,    3.42283e-16,    1.134e-17,
        0,              0,              0,              0,              0,              0,              0,
        0,              0,              0,              0,              0,              0,              0,
        0,              0,              0,              0,              0,              0,              0,
        ],

    '2017_runE' : [
        9.976e-09,      0.00430579,     0.0197936,      0.0195893,      0.0469575,      0.0856007,      0.0898606,
        0.133994,       0.074991,       0.10824,        0.0873948,      0.118887,       0.178507,       0.249594,
        0.318471,       0.389619,       0.490148,       0.593916,       0.727234,       0.848012,       0.941199,
        1.00838,        1.05839,        1.07527,        1.05638,        1.03848,        1.0103,         1.01924,
        1.04871,        1.08311,        1.12128,        1.15404,        1.17759,        1.19714,        1.19476,
        1.21012,        1.23627,        1.25266,        1.26754,        1.28955,        1.33681,        1.44395,
        1.5323,         1.6388,         1.76053,        1.85531,        1.89803,        1.82405,        1.74553,
        1.58955,        1.39009,        1.19177,        0.995484,       0.810875,       0.642734,       0.483302,
        0.373428,       0.284424,       0.215222,       0.164329,       0.129213,       0.103762,       0.0852167,
        0.070273,       0.0616186,      0.0479701,      0.0382311,      0.0339894,      0.0327391,      0.0324185,
        0.0304894,      0.0291627,      0.0222454,      0.022956,       0.0125378,      0.0194903,      0.0108263,
        0.0088362,      0.00461907,     0.00326246,     0.000882622,    0.00162985,     0.00145087,     0.000493156,
        0.000347263,    0.000220807,    0.000401183,    6.47169e-05,    5.87115e-05,    4.06217e-05,    0.000117842,
        5.07655e-05,    6.49354e-05,    6.13054e-05,    6.33085e-06,    4.22432e-06,    6.19473e-06,    3.46389e-06,
        5.66718e-06,    1.1995e-06,
        ],
    '2017_runF' : [
         0.000791184,    0.113765,       0.161239,       0.134982,       0.09516,        0.130148,       0.116681,
         0.115613,       0.131078,       0.753048,       1.01439,        1.24964,        1.06256,        0.783467,
         0.58507,        0.488352,       0.475015,       0.465189,       0.474411,       0.48612,        0.525865,
         0.604733,       0.694277,       0.743258,       0.742267,       0.730203,       0.703604,       0.694884,
         0.693959,       0.69485,        0.703141,       0.718069,       0.738532,       0.767131,       0.791625,
         0.835908,       0.891396,       0.937885,       0.980591,       1.03486,        1.13255,        1.32895,
         1.58039,        1.93993,        2.4177,         2.94552,        3.43089,        3.66776,        3.79819,
         3.63427,        3.24338,        2.76013,        2.23112,        1.72014,        1.26752,        0.874813,
         0.616495,       0.428977,       0.299926,       0.216405,       0.166374,       0.136477,       0.120221,
         0.111475,       0.114341,       0.107111,       0.10444,        0.114357,       0.135551,       0.164229,
         0.18735,        0.215157,       0.194953,       0.236431,       0.150195,       0.268901,       0.170417,
         0.157279,       0.092175,       0.0723903,      0.0216036,      0.0436668,      0.0422279,      0.0154774,
         0.0116665,      0.0078836,      0.0151136,      0.00255425,     0.00241046,     0.00172259,     0.00512494,
         0.00224817,     0.0029075,      0.00275556,     0.000283618,    0.000187269,    0.000269796,    0.000147143,
         0.000233107,    4.74285e-05,
         ],

    '2017_runBCDEF' : [0.000319471, 0.043333,  0.0627865,  0.0647238,  0.0780242, 0.108199,  0.111983,
                 0.148095,    0.112399,  0.381801,   0.494781,   0.647735,  0.674107,  0.687767,
                 0.723788,    0.784618,  0.898843,   0.979519,   1.0633,    1.11899,   1.16819,
                 1.22006,     1.27549,   1.30905,    1.31339,    1.32447,   1.31354,   1.32983,
                 1.34375,     1.33185,   1.29874,    1.24632,    1.18278,   1.11995,   1.04354,
                 0.988411,    0.944833,  0.896181,   0.851375,   0.820549,  0.820257,  0.877121,
                 0.9505,      1.06921,   1.23497,    1.41449,    1.57161,   1.62378,   1.64322,
                 1.5508,      1.37578,   1.1718,     0.953895,   0.744876,  0.558862,  0.394524,
                 0.285334,    0.20402,   0.146289,   0.107565,   0.0833341, 0.0678563, 0.0583878,
                 0.0521837,   0.0511854, 0.0457683,  0.042717,   0.0450134, 0.0516682, 0.0609794,
                 0.0681131,   0.0769145, 0.068758,   0.082488,   0.0519442, 0.0923373, 0.0581781,
                 0.0534347,   0.031191,  0.0244144,  0.00726572, 0.0146515, 0.0141407, 0.00517426,
                 0.00389476,  0.00262877,0.00503468, 0.000850185,0.00080179,0.00057269,0.00170316,
                 0.000746922, 0.00096581,0.00091529, 9.42116e-05,6.2216e-05,8.9658e-05,4.89178e-05,
                 7.75365e-05, 1.57862e-05],

    }

puMC = {
    'Spring2016MC_PUscenarioV1' : [ 0.000829312873542, 0.00124276120498, 0.00339329181587, 0.00408224735376, 0.00383036590008, 
                                    0.00659159288946,  0.00816022734493, 0.00943640833116, 0.0137777376066,  0.017059392038,
                                    0.0213193035468,   0.0247343174676,  0.0280848773878,  0.0323308476564,  0.0370394341409,  
                                    0.0456917721191,   0.0558762890594,  0.0576956187107,  0.0625325287017,  0.0591603758776,
                                    0.0656650815128,   0.0678329011676,  0.0625142146389,  0.0548068448797,  0.0503893295063,  
                                    0.040209818868,    0.0374446988111,  0.0299661572042,  0.0272024759921,  0.0219328403791,
                                    0.0179586571619,   0.0142926728247,  0.00839941654725, 0.00522366397213, 0.00224457976761, 
                                    0.000779274977993, 0.000197066585944,7.16031761328e-05,0.0             , 0.0,
                                    0.0,        0.0,        0.0,        0.0,        0.0,    
                                    0.0,        0.0,        0.0,        0.0,        0.0],
    
    'Moriond17MC_mix_2016'      : [ 1.78653e-05 ,2.56602e-05 ,5.27857e-05 ,8.88954e-05 ,0.000109362 ,0.000140973 ,0.000240998 ,
                                    0.00071209  , 0.00130121 ,0.00245255  ,0.00502589  ,0.00919534  ,0.0146697   ,0.0204126   ,
                                    0.0267586   ,0.0337697   ,0.0401478   ,0.0450159   ,0.0490577   ,0.0524855   ,0.0548159   ,
                                    0.0559937   ,0.0554468   ,0.0537687   ,0.0512055   ,0.0476713   ,0.0435312   ,0.0393107   ,
                                    0.0349812   ,0.0307413   ,0.0272425   ,0.0237115   ,0.0208329   ,0.0182459   ,0.0160712   ,
                                    0.0142498   ,0.012804    ,0.011571    ,0.010547    ,0.00959489  ,0.00891718  ,0.00829292  , 
                                    0.0076195   ,0.0069806   ,0.0062025   ,0.00546581  ,0.00484127  ,0.00407168  ,0.00337681  ,
                                    0.00269893  ,0.00212473  ,0.00160208  ,0.00117884  ,0.000859662 ,0.000569085 ,0.000365431 ,
                                    0.000243565 ,0.00015688  ,9.88128e-05 ,6.53783e-05 ,3.73924e-05 ,2.61382e-05 ,2.0307e-05  ,
                                    1.73032e-05 ,1.435e-05   ,1.36486e-05 ,1.35555e-05 ,1.37491e-05 ,1.34255e-05 ,1.33987e-05 ,
                                    1.34061e-05 ,1.34211e-05 ,1.34177e-05 ,1.32959e-05 ,1.33287e-05 ],

   
    'mix_2017_25ns_UltraLegacy_PoissonOOTPU' : [ 1.1840841518e-05, 3.46661037703e-05, 8.98772521472e-05, 7.47400487733e-05, 0.000123005176624,
                                                 0.000156501700614, 0.000154660478659, 0.000177496185603, 0.000324149805611, 0.000737524009713,
                                                 0.00140432980253, 0.00244424508696, 0.00380027898037, 0.00541093042612, 0.00768803501793,
                                                 0.010828224552, 0.0146608623707, 0.01887739113, 0.0228418813823, 0.0264817796874,
                                                 0.0294637401336, 0.0317960986171, 0.0336645950831, 0.0352638818387, 0.036869429333,
                                                 0.0382797316998, 0.039386705577, 0.0398389681346, 0.039646211131, 0.0388392805703,
                                                 0.0374195678161, 0.0355377892706, 0.0333383902828, 0.0308286549265, 0.0282914440969,
                                                 0.0257860718304, 0.02341635055, 0.0213126338243, 0.0195035612803, 0.0181079838989,
                                                 0.0171991315458, 0.0166377598339, 0.0166445341361, 0.0171943735369, 0.0181980997278,
                                                 0.0191339792146, 0.0198518804356, 0.0199714909193, 0.0194616474094, 0.0178626975229,
                                                 0.0153296785464, 0.0126789254325, 0.0100766041988, 0.00773867100481, 0.00592386091874,
                                                 0.00434706240169, 0.00310217013427, 0.00213213401899, 0.0013996000761, 0.000879148859271,
                                                 0.000540866009427, 0.000326115560156, 0.000193965828516, 0.000114607606623, 6.74262828734e-05,
                                                 3.97805301078e-05, 2.19948704638e-05, 9.72007976207e-06, 4.26179259146e-06, 2.80015581327e-06,
                                                 1.14675436465e-06, 2.52452411995e-07, 9.08394910044e-08, 1.14291987912e-08, 0.0,
                                                 0.0, 0.0, 0.0, 0.0, 0.0,
                                                 0.0, 0.0, 0.0, 0.0, 0.0,
                                                 0.0, 0.0, 0.0, 0.0, 0.0,
                                                 0.0, 0.0, 0.0, 0.0, 0.0,
                                                 0.0, 0.0, 0.0, 0.0],


    'Moriond18MC_mix_2017' :[3.39597497605e-05,    6.63688402133e-06,     1.39533611284e-05,     3.64963078209e-05,     6.00872171664e-05,     9.33932578027e-05,    0.000120591524486,
                             0.000128694546198,    0.000361697233219,     0.000361796847553,     0.000702474896113,     0.00133766053707,      0.00237817050805,     0.00389825605651,
                             0.00594546732588,     0.00856825906255,      0.0116627396044,       0.0148793350787,       0.0179897368379,       0.0208723871946,      0.0232564170641,
                             0.0249826433945,      0.0262245860346,       0.0272704617569,       0.0283301107549,       0.0294006137386,       0.0303026836965,      0.0309692426278,   
                             0.0308818046328,      0.0310566806228,       0.0309692426278,       0.0310566806228,       0.0310566806228,       0.0310566806228,      0.0307696426944,
                             0.0300103336052,      0.0288355370103,       0.0273233309106,       0.0264343533951,       0.0255453758796,       0.0235877272306,      0.0215627588047,
                             0.0195825559393,      0.0177296309658,       0.0160560731931,       0.0146022004183,       0.0134080690078,       0.0129586991411,      0.0125093292745,
                             0.0124360740539,      0.0123547104433,       0.0123953922486,       0.0124360740539,       0.0124360740539,       0.0123547104433,      0.0124360740539,
                             0.0123387597772,      0.0122414455005,       0.011705203844,        0.0108187105305,       0.00963985508986,      0.00827210065136,     0.00683770076341,
                             0.00545237697118,     0.00420456901556,      0.00367513566191,      0.00314570230825,      0.0022917978982,       0.00163221454973,     0.00114065309494,
                             0.000784838366118,    0.000533204105387,     0.000358474034915,     0.000238881117601,     0.0001984254989,       0.000157969880198,    0.00010375646169,
                             6.77366175538e-05,    4.39850477645e-05,     2.84298066026e-05,     1.83041729561e-05,     1.17473542058e-05,     7.51982735129e-06,    6.16160108867e-06,
                             4.80337482605e-06,    3.06235473369e-06,     1.94863396999e-06,     1.23726800704e-06,     7.83538083774e-07,     4.94602064224e-07,    3.10989480331e-07,
                             1.94628487765e-07,    1.57888581037e-07,     1.2114867431e-07,      7.49518929908e-08,     4.6060444984e-08,      2.81008884326e-08,    1.70121486128e-08,
                             1.02159894812e-08],


#https://github.com/cms-sw/cmssw/blob/master/SimGeneral/MixingModule/python/mix_2018_25ns_UltraLegacy_PoissonOOTPU_cfi.py

    'mix_2018_25ns_UltraLegacy_PoissonOOTPU' :[8.89374611122e-07, 1.1777062868e-05, 3.99725585118e-05, 0.000129888015252, 0.000265224848687,
   0.000313088635109, 0.000353781668514, 0.000508787237162, 0.000873670065767, 0.00147166880932,
    0.00228230649018, 0.00330375581273, 0.00466047608406, 0.00624959203029, 0.00810375867901,
    0.010306521821, 0.0129512453978, 0.0160303925502, 0.0192913204592, 0.0223108613632,
    0.0249798930986, 0.0273973789867, 0.0294402350483, 0.031029854302, 0.0324583524255,
    0.0338264469857, 0.0351267479019, 0.0360320204259, 0.0367489568401, 0.0374133183052,
    0.0380352633799, 0.0386200967002, 0.039124376968, 0.0394201612616, 0.0394673457109,
    0.0391705388069, 0.0384758587461, 0.0372984548399, 0.0356497876549, 0.0334655175178,
    0.030823567063, 0.0278340752408, 0.0246009685048, 0.0212676009273, 0.0180250593982,
    0.0149129830776, 0.0120582333486, 0.00953400069415, 0.00738546929512, 0.00563442079939,
    0.00422052915668, 0.00312446316347, 0.00228717533955, 0.00164064894334, 0.00118425084792,
    0.000847785826565, 0.000603466454784, 0.000419347268964, 0.000291768785963, 0.000199761337863,
    0.000136624574661, 9.46855200945e-05, 6.80243180179e-05, 4.94806013765e-05, 3.53122628249e-05,
    2.556765786e-05, 1.75845711623e-05, 1.23828210848e-05, 9.31669724108e-06, 6.0713272037e-06,
    3.95387384933e-06, 2.02760874107e-06, 1.22535149516e-06, 9.79612472109e-07, 7.61730246474e-07,
    4.2748847738e-07, 2.41170461205e-07, 1.38701083552e-07, 3.37678010922e-08, 0.0,
    0.0, 0.0, 0.0, 0.0, 0.0,
    0.0, 0.0, 0.0, 0.0, 0.0,
    0.0, 0.0, 0.0, 0.0, 0.0,
    0.0, 0.0, 0.0, 0.0],

    ## copied from https://github.com/cms-sw/cmssw/blob/master/SimGeneral/MixingModule/python/mix_2016_25ns_UltraLegacy_PoissonOOTPU_cfi.py
    'mix_2016_25ns_UltraLegacy_PoissonOOTPU' :[1.00402360149e-05, 5.76498797172e-05, 7.37891400294e-05, 0.000110932895295, 0.000158857714773,
   0.000368637432599, 0.000893114107873, 0.00189700774575, 0.00358880167437, 0.00636052573486,
    0.0104173961179, 0.0158122597405, 0.0223785660712, 0.0299186888073, 0.0380275944896,
    0.0454313901624, 0.0511181088317, 0.0547434577348, 0.0567906239028, 0.0577145461461,
    0.0578176902735, 0.0571251566494, 0.0555456541498, 0.053134383488, 0.0501519041462,
    0.0466815838899, 0.0429244592524, 0.0389566776898, 0.0348507152776, 0.0307356862528,
    0.0267712092206, 0.0229720184534, 0.0193388653099, 0.0159602510813, 0.0129310510552,
    0.0102888654183, 0.00798782770975, 0.00606651703058, 0.00447820948367, 0.00321589786478,
    0.0022450422045, 0.00151447388514, 0.000981183695515, 0.000609670479759, 0.000362193408119,
    0.000211572646801, 0.000119152364744, 6.49133515399e-05, 3.57795801581e-05, 1.99043569043e-05,
    1.13639319832e-05, 6.49624103579e-06, 3.96626216416e-06, 2.37910222874e-06, 1.50997403362e-06,
    1.09816650247e-06, 7.31298519122e-07, 6.10398791529e-07, 3.74845774388e-07, 2.65177281359e-07,
    2.01923536742e-07, 1.39347583555e-07, 8.32600052913e-08, 6.04932421298e-08, 6.52536630583e-08,
    5.90574603808e-08, 2.29162474068e-08, 1.97294602668e-08, 1.7731096903e-08, 3.57547932012e-09,
    1.35039815662e-09, 8.50071242076e-09, 5.0279187473e-09, 4.93736669066e-10, 8.13919708923e-10,
    5.62778926097e-09, 5.15140589469e-10, 8.21676746568e-10, 0.0, 1.49166873577e-09,
    8.43517992503e-09, 0.0, 0.0, 0.0, 0.0,
    0.0, 0.0, 0.0, 0.0, 0.0,
    0.0, 0.0, 0.0, 0.0, 0.0,
    0.0, 0.0, 0.0, 0.0],

    'mix_2022' : [7.075550618391933e-8, 1.8432226484975646e-7, 4.6156514471969593e-7, 0.0000011111611991838491, 
	0.0000025719752161798103, 0.000005724865812608344, 0.000012255841383374045, 0.000025239403069596116, 0.00005001054998201597, 
	0.00009536530158990567, 0.00017505633393457624, 0.00030942214916825035, 0.0005268123536229287, 0.0008642843968521786, 
	0.0013669182280399903, 0.0020851167548246985, 0.0030695148409245446, 0.004363635945105083, 0.005995143197404548, 
	0.007967247822222358, 0.010252302872826594, 0.01278957659177177, 0.015488544412469806, 0.01823784978331645, 
	0.020918669702105028, 0.023420019399650906, 0.025652949149203495, 0.027560835627835043, 0.02912397347687914, 
	0.030358091266301533, 0.03130778480604892, 0.03203676872496023, 0.0326170853351521, 0.03311902652393314, 
	0.033602777248239, 0.0341120235754556, 0.03466927947785801, 0.03527261707506484, 0.035893786618889145, 
	0.03647817900850185, 0.036947435730750315, 0.03720550450678737, 0.037148460727673235, 0.03667753703450604, 
	0.03571377296329832, 0.034211859754226276, 0.032170439241889726, 0.029636506070368274, 0.02670262519076345, 
	0.023497154911314072, 0.020169158697337236, 0.016870783471647905, 0.013740289679427057, 0.010888563843704815, 
	0.008390977574442656, 0.006285186751143873, 0.004574246293656772, 0.003233538335807419, 0.002219622271900557, 
	0.0014792038980537092, 0.0009568560481315006, 0.0006007171037926386, 0.00036596934105178995, 0.0002163349104153549, 
	0.00012407362512604619, 0.0000690356949524181, 0.000037263645547231494, 0.00001951170588910065, 0.000009910336118978026, 
	0.0000048826244075428666, 0.0000023333596885075797, 0.0000010816029570543702, 4.863048449289416e-7, 2.1208148308081624e-7, 
	8.97121135679932e-8, 3.6809172420519874e-8, 1.4649459937201982e-8, 5.655267024863598e-9, 2.117664468591336e-9, 
	7.692038404370259e-10, 2.7102837405697987e-10, 9.263749466613295e-11, 3.071624552355945e-11, 9.880298997379985e-12, 
	3.0832214331312204e-12, 9.33436314183754e-13, 2.7417209623761203e-13, 7.813293248960901e-14, 2.1603865264197903e-14, 
	5.796018523167997e-15, 1.5088422256459697e-15, 3.811436255838504e-16, 9.342850737730402e-17, 2.2224464483477953e-17, 
	5.130498608124184e-18, 1.1494216669980747e-18, 2.499227229379666e-19, 5.2741621866055994e-20, 1.080281961755894e-20, 
	2.1476863811171814e-21],

    'mix_2023_25ns_EraCD_PoissonOOTPU' :[
        7.24105826767e-05, 4.38099640951e-05, 5.76790506008e-05, 5.92746441577e-05, 6.80254450023e-05,
        8.37466197998e-05, 8.60740558549e-05, 8.50779958485e-05, 9.01712987088e-05, 9.57536364956e-05,
        9.5903567079e-05, 0.000103849795967, 0.000135108592006, 0.000127174966572, 0.000142278810925,
        0.000171186164459, 0.000224174186731, 0.000339093548271, 0.000490526897074, 0.000647186042883,
        0.000843143398777, 0.00113061546306, 0.0015004244922, 0.00196004453998, 0.00258218735412,
        0.00336283002888, 0.00435943783835, 0.00558506395076, 0.00707710504253, 0.0087145334486,
        0.0102377963937, 0.0117222352279, 0.0131501211426, 0.0144544204738, 0.0156133338779,
        0.0167860167581, 0.0179050687884, 0.0188086192213, 0.019602772567, 0.0202545948834,
        0.0208328088348, 0.0213564761994, 0.0217720102066, 0.0221774321989, 0.0224852345544,
        0.0228463510262, 0.023309067363, 0.0239947576528, 0.0247957730948, 0.0259095042329,
        0.0270134185127, 0.0281592985882, 0.0296822247224, 0.031210729369, 0.0328303300406,
        0.0346202219124, 0.0360386524668, 0.0369403479999, 0.0369401765361, 0.036060907025,
        0.0341993333649, 0.031599792493, 0.0285065172292, 0.0250776462845, 0.0217073931283,
        0.018636532191, 0.0158077346058, 0.0132402957923, 0.0109657025451, 0.00897646902149,
        0.0073302975131, 0.005887542428, 0.00464701426691, 0.0036520541874, 0.0028696817983,
        0.00229282040295, 0.00182237708814, 0.00144628834384, 0.00109954275656, 0.000804825890922,
        0.000562893050491, 0.000382031990888, 0.000252113109331, 0.000152168130439, 8.67240473287e-05,
        5.37520917267e-05, 3.40952344482e-05, 2.33292349693e-05, 1.54199214697e-05, 8.26672143774e-06,
        5.66028212915e-06, 4.43409489599e-06, 2.79144305141e-06, 1.65669765968e-06, 1.18531603755e-07,
        6.80378909099e-08, 2.27550463906e-08, 0.0, 0.0, 0.0
    ],

    'mix_2023_25ns_EraC_PoissonOOTPU' :[
        2.38822148706e-05, 4.75152134008e-05, 6.30191527793e-05, 6.68452240771e-05, 8.1025250051e-05,
        9.79468565963e-05, 9.95081424719e-05, 9.33708830231e-05, 9.50909917671e-05, 0.000100651134241,
        0.000103078257098, 0.000111034560318, 0.000122287617571, 0.000133124512985, 0.00014956573019,
        0.000186137627395, 0.000228156756843, 0.000282331058406, 0.000331622711531, 0.000391461449341,
        0.000517949289644, 0.000772840072265, 0.00117177950147, 0.00170218286606, 0.00236820136292,
        0.00313598312592, 0.00408745219886, 0.00527840094237, 0.00673298586987, 0.00828009786211,
        0.00981421228066, 0.0113605372864, 0.0128822615559, 0.0143533259986, 0.0156697830309,
        0.0169254217283, 0.018080221643, 0.0189942713703, 0.0198224792894, 0.0205857576279,
        0.0212350460744, 0.0217526935632, 0.022272803428, 0.0228031352959, 0.0231877786772,
        0.0236794597607, 0.0242098757217, 0.0250255926642, 0.0259084771241, 0.0270883359038,
        0.0283842141201, 0.0296138041433, 0.0312398518545, 0.0328769694128, 0.0343573284679,
        0.0359444082242, 0.0371707283039, 0.0379191373689, 0.0376984798185, 0.0364701631509,
        0.0342333461199, 0.030918081708, 0.02719246186, 0.0234422219723, 0.0199428306976,
        0.0167530883095, 0.0139446903019, 0.0115684641268, 0.0095875821463, 0.00792109671955,
        0.00642645801884, 0.00514147006535, 0.004014647174, 0.00312068891816, 0.00254047982771,
        0.00206998047115, 0.00170256713492, 0.00142457093791, 0.00112986818813, 0.000874387606181,
        0.000666515127689, 0.000479354340271, 0.000316491543232, 0.000182306321277, 9.7983507813e-05,
        5.59397929391e-05, 3.25116880719e-05, 2.05226891643e-05, 1.08317242834e-05, 4.61503191047e-06,
        1.49869506368e-06, 3.4791503138e-07, 1.59930964479e-08, 0.0, 0.0,
        0.0, 0.0, 0.0, 0.0, 0.0
    ],

    'mix_2023_25ns_EraD_PoissonOOTPU' :[
        0.000158878446531, 3.72079495004e-05, 4.81640545476e-05, 4.57853820338e-05, 4.48623875183e-05,
        5.84446325801e-05, 6.21371953105e-05, 7.03017263882e-05, 8.14053877829e-05, 8.70272731863e-05,
        8.31197017269e-05, 9.10479801679e-05, 0.000157953009035, 0.000116574062554, 0.000129294975462,
        0.000144545642223, 0.000217078041821, 0.000440232973883, 0.000773662434135, 0.00110283621902,
        0.00142257438371, 0.00176809978781, 0.00208600425923, 0.00241950256675, 0.00296346767304,
        0.00376702592516, 0.00484406195225, 0.00613147621346, 0.00769025671271, 0.00948861093862,
        0.0109925387243, 0.0123667087551, 0.013627393454, 0.0146345506473, 0.015512752756,
        0.0165376249303, 0.0175929813666, 0.018477824153, 0.0192112990472, 0.0196645289817,
        0.0201161023712, 0.0206504959528, 0.020879696658, 0.0210625541872, 0.0212334411744,
        0.0213619175725, 0.0217040066936, 0.022158015445, 0.0228131566405, 0.0238090615222,
        0.0245709343881, 0.0255676600477, 0.0269068441176, 0.0282418222377, 0.0301095236733,
        0.0322607862482, 0.0340215193181, 0.0351963407371, 0.0355890314646, 0.0353316943073,
        0.0341387294252, 0.0328144650238, 0.0308479015762, 0.0279916459339, 0.0248514911256,
        0.0219924532015, 0.0191273076414, 0.0162191660774, 0.0134212379857, 0.0108569317827,
        0.00894075906105, 0.00721689444201, 0.00577376618889, 0.0045988410223, 0.00345625399226,
        0.00268987667653, 0.00203585450746, 0.00148498442583, 0.00104550889127, 0.000680880800731,
        0.000378259194695, 0.000208622992464, 0.000137403591797, 9.84678907631e-05, 6.66619364389e-05,
        4.98540448905e-05, 3.6916797972e-05, 2.83299393313e-05, 2.35951729274e-05, 1.47733031993e-05,
        1.30753995144e-05, 1.17148517026e-05, 7.73674081622e-06, 4.60860216753e-06, 3.2973125953e-07,
        1.89267830307e-07, 6.32999965354e-08, 0.0, 0.0, 0.0
    ]
}

### MC pu scenario to be used
#puMCscenario = 'mix_2022'
#puMCscenario = 'mix_2023_25ns_EraC_PoissonOOTPU' 
puMCscenario = 'mix_2023_25ns_EraD_PoissonOOTPU'
customWeightsName= 'weights'
#puDirEOS = '/eos/cms/store/group/phys_egamma/ec/tnpTuples/Prompt2023/pileupReweightingFiles/'
#puDirEOS = '/eos/cms/store/group/phys_egamma/abelvede/pileupReweightingFiles/'
puDirEOS = './PU_Trees/'


#### Compute weights for all data epoch specified below
puDataEpoch = {
    #'data_Run2023C' : puDirEOS + 'Data2023C_PileupHistogram.root',
    'data_Run2023D' : puDirEOS + 'Data2023D_PileupHistogram.root',
    #'data_Run2022BCD' : puDirEOS + 'Data2022_BCD_PileupHistogram_69p2mb.root',
    #'data_Run2022EFG' : puDirEOS + 'Data2022_EFG_PileupHistogram_69p2mb.root',
    }

nVtxDataEpoch = {
    '2016_runBCD' : 'etc/inputs/nVtx_2016_runBCD.root',
    '2016_runEF'  : 'etc/inputs/nVtx_2016_runEF.root' ,
    '2016_runGH'  : 'etc/inputs/nVtx_2016_runGH.root' ,
}

rhoDataEpoch = {
    '2016_runE'   : 'etc/inputs/rho_pu_runE.root',
    '2016_runGH'  : 'etc/inputs/rho_pu_runGH.root',
}



def reweight( sample, puType = 0,useCustomW=False  ):
    if sample.path is None:
        print '[puReweighter]: Need to know the MC tree (option --mcTree or sample.path)'
        sys.exit(1)
    

### create a tree with only weights that will be used as friend tree for reweighting different lumi periods
    print 'Opening mc file: ', sample.path[0]
    fmc = rt.TFile(sample.path[0],'read')
    tmc = None
    if sample.tnpTree is None:
        dirs = fmc.GetListOfKeys()
        for d in dirs:
            if (d.GetName() == "sampleInfo"): continue
            tmc = fmc.Get("%s/fitter_tree" % d.GetName())
    else:
        tmc = fmc.Get(sample.tnpTree)
    

#### can reweight vs nVtx but better to reweight v truePU
    puMCnVtx = []
    puMCrho = []
    if   puType == 1 :
        hmc   = rt.TH1F('hMC_nPV'  ,'MC nPV'  , 75,-0.5,74.5)
        tmc.Draw('event_nPV>>hMC_nPV','','goff')
        hmc.Scale(1/hmc.Integral())
        for ib in range(1,hmc.GetNbinsX()+1):
            puMCnVtx.append( hmc.GetBinContent(ib) )
        print 'len nvtxMC = ',len(puMCnVtx)

    elif puType == 2 :
        hmc   = rt.TH1F('hMC_rho'  ,'MC #rho'  , 75,-0.5,74.5)
        tmc.Draw('rho>>hMC_rho','','goff')
        hmc.Scale(1/hmc.Integral())
        for ib in range(1,hmc.GetNbinsX()+1):
            puMCrho.append( hmc.GetBinContent(ib) )
        print 'len rhoMC = ',len(puMCrho)
    

    puDataDist = {}
    puDataArray= {}
    weights = {}
    epochKeys = puDataEpoch.keys()
    if puType == 1  : epochKeys = nVtxDataEpoch.keys()
    if puType == 2  : epochKeys = rhoDataEpoch.keys()
 
    for pu in epochKeys:
        fpu = None
        if   puType == 1 : fpu = rt.TFile(nVtxDataEpoch[pu],'read')
        elif puType == 2 : fpu = rt.TFile(rhoDataEpoch[pu],'read')
        else             : fpu = rt.TFile(puDataEpoch[pu],'read')
        puDataDist[pu] = fpu.Get('pileup').Clone('puHist_%s' % pu)
        puDataDist[pu].Scale(1./puDataDist[pu].Integral())
        puDataDist[pu].SetDirectory(0)
        puDataArray[pu] = []
        for ipu in range(len(puMC[puMCscenario])):
            ibin_pu  = puDataDist[pu].GetXaxis().FindBin(ipu+0.00001)
            puDataArray[pu].append(puDataDist[pu].GetBinContent(ibin_pu))
        print 'puData[%s] length = %d' % (pu,len(puDataArray[pu]))
        fpu.Close()
        weights[pu] = []

    #mcEvts = tree2array( tmc, branches = ['weight','truePU','event_nPV','rho'] )
    mcEvts = tree2array( tmc, branches = ['weight','truePU','event_nPV'])#,'rho'] )


    pumc = puMC[puMCscenario]
    if   puType == 1:  pumc = puMCnVtx
    elif puType == 2:  pumc = puMCrho
    else            :  pumc = puMC[puMCscenario]

    puMax = len(pumc)
    print '-> nEvtsTot ', len(mcEvts)
#    print "--------------------------" 
    for ievt in xrange(len(mcEvts)):
        if ievt%100000 == 0 :            print 'iEvt:',ievt
#        print 'iEvt:',ievt
        evt = mcEvts[ievt]
        for pu in epochKeys:
#            print pu
#AR            customWeights=customWeights_17Nov2017MCv2[pu]
#            print customWeights_17Nov2017MCv2[pu]
#            print "--------------------------"
            pum = -1
            pud = -1
            if puType == 1 and evt['event_nPV'] < puMax:
                pud = puDataArray[pu][evt['event_nPV']]
                pum = pumc[evt['event_nPV']]
            if puType == 2 and int(evt['rho']) < puMax:
                pud = puDataArray[pu][int(evt['rho'])]
                pum = pumc[int(evt['rho'])]
            elif puType == 0:
#                if ievt%1000: print pu, evt['truePU']
                if evt['truePU']> 0 and evt['truePU']<99: 
                    pud = puDataArray[pu][evt['truePU']] 
                    pum = pumc[evt['truePU']]
            puw = 0
            if pum > 0: 
                puw  = pud/pum
#                if use customized weights
            if useCustomW:
                puw=0
                if  evt['truePU']> 0 and evt['truePU']<97:
                    puw = customWeights[evt['truePU']]
                
#                    print evt['truePU'],puw

            if evt['weight'] > 0 : totw = +puw
            else                 : totw = -puw
            weights[pu].append( ( puw,totw) )
    print "====================="
    print weights[pu]

    newFile    = rt.TFile( sample.puTree, 'recreate')

    for pu in epochKeys:
        treeWeight = rt.TTree('weights_%s'%pu,'tree with weights')
        wpuarray = np.array(weights[pu],dtype=[('PUweight',float),('totWeight',float)])
        array2tree( wpuarray, tree = treeWeight )
        treeWeight.Write()

    newFile.Close()    
    fmc.Close()


if __name__ == "__main__":
    parser = argparse.ArgumentParser(description='tnp EGM pu reweighter')
    parser.add_argument('--mcTree'  , dest = 'path',  default = None, help = 'MC tree to compute weights for')
    parser.add_argument('puTree'    , default = None                , help = 'output puTree')

    args = parser.parse_args()
    args.path = [args.path]
    reweight(args)





